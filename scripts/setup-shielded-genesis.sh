#!/usr/bin/env bash
#
# Generate genesis accounts for YaCoin Shielded Pool
#

set -e

script_dir="$(readlink -f "$(dirname "$0")")"
cd "$script_dir/.."

# Check if yacoin-shielded-cli exists
SHIELDED_CLI="./target/release/yacoin-shielded-cli"
if [[ ! -x "$SHIELDED_CLI" ]]; then
    echo "Building yacoin-shielded-cli..."
    cargo build --release --bin yacoin-shielded-cli
fi

# Generate genesis accounts YAML
echo "Generating shielded pool genesis accounts..."
$SHIELDED_CLI genesis-accounts > shielded-pool-genesis.yaml 2>/dev/null || {
    echo "Warning: Could not generate genesis accounts via CLI"
    echo "Creating minimal genesis accounts..."

    # Program ID: ShieLdedTransfer11111111111111111111111111
    # This is the hex encoding from lib.rs
    PROGRAM_ID="5368694c646564547261e673666572313131313131313131313131313131313131"

    cat > shielded-pool-genesis.yaml << 'EOF'
# YaCoin Shielded Pool Genesis Accounts
# These accounts are owned by the Shielded Transfer builtin program

# Pool State Account (PDA: seed = "shielded_pool")
# Address computed from find_program_address([b"shielded_pool"], program_id)
- pubkey: "8JQxVRhawWmLVMg3g45P5mPKDc2TwwqNsKPNNxyBcYvj"
  balance: 1000000000
  owner: "ShieLdedTransfer11111111111111111111111111"
  data: "base64,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
  executable: false

# Commitment Tree Account (PDA: seed = "commitment_tree")
- pubkey: "4vLnGUj9B6EtJ4wPTUqCdmZPMkMqJvTBx4YfmkmXyZ1f"
  balance: 10000000000
  owner: "ShieLdedTransfer11111111111111111111111111"
  data: "base64,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
  executable: false

# Nullifier Set Account (PDA: seed = "nullifier_set")
- pubkey: "FNVmzPFmXn2L4CYvKujgLEr9mN9KjrCr9xqfVvBQhNfE"
  balance: 100000000000
  owner: "ShieLdedTransfer11111111111111111111111111"
  data: "base64,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
  executable: false

# Recent Anchors Account (PDA: seed = "recent_anchors")
- pubkey: "HqeKPwH7FwXnVhPDLLYQzYqMEKYkjzQwrxN5jQNqCvDS"
  balance: 100000000
  owner: "ShieLdedTransfer11111111111111111111111111"
  data: "base64,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZAAAAAAAAAA="
  executable: false
EOF
}

if [[ -f shielded-pool-genesis.yaml ]]; then
    echo "Shielded pool genesis accounts written to shielded-pool-genesis.yaml"
    echo ""
    echo "Add to yacoin-genesis with:"
    echo "  --primordial-accounts-file shielded-pool-genesis.yaml"
else
    echo "ERROR: Failed to create genesis accounts"
    exit 1
fi
